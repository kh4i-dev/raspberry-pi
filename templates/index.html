<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="/static/img/logo.png" type="image/png">
    <title>B·∫£ng ƒêi·ªÅu Khi·ªÉn H·ªá Th·ªëng Ph√¢n Lo·∫°i</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        .status-card,
        .log-card,
        .test-card {
            transition: all 0.3s ease-in-out;
        }

        .status-dot {
            transition: all 0.3s ease-in-out;
        }

        .log-item {
            animation: fadeIn 0.5s ease-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .pulse-blue {
            animation: pulse-blue 2s infinite;
        }

        .pulse-yellow {
            animation: pulse-yellow 2s infinite;
        }

        @keyframes pulse-blue {
            0% {
                box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.7);
            }

            70% {
                box-shadow: 0 0 0 10px rgba(59, 130, 246, 0);
            }

            100% {
                box-shadow: 0 0 0 0 rgba(59, 130, 246, 0);
            }
        }

        @keyframes pulse-yellow {
            0% {
                box-shadow: 0 0 0 0 rgba(234, 179, 8, 0.7);
            }

            70% {
                box-shadow: 0 0 0 10px rgba(234, 179, 8, 0);
            }

            100% {
                box-shadow: 0 0 0 0 rgba(234, 179, 8, 0);
            }
        }

        /* Toggle Switch Styles */
        .toggle-wrapper {
            position: relative;
            width: 42px;
            height: 22px;
            background-color: #4b5563;
            border-radius: 9999px;
            transition: background-color 0.3s ease;
            cursor: pointer;
        }

        .toggle-circle {
            position: absolute;
            top: 2px;
            left: 2px;
            width: 18px;
            height: 18px;
            background-color: white;
            border-radius: 50%;
            transition: transform 0.3s ease, background-color 0.3s ease;
        }

        .toggle-input:checked+.toggle-wrapper {
            background-color: #22c55e;
        }

        .toggle-input:checked+.toggle-wrapper .toggle-circle {
            transform: translateX(20px);
            background-color: #16a34a;
        }

        .toggle-input:disabled+.toggle-wrapper {
            cursor: not-allowed;
            background-color: #374151;
        }

        /* Nav Button Styles */
        .nav-btn.active {
            background-color: #16a34a;
            color: white;
        }
    </style>
</head>

<body class="bg-gray-900 text-white">

    <div class="container mx-auto p-4 md:p-8">
        <header class="text-center mb-4">
            <h1 class="text-3xl md:text-4xl font-bold text-green-400">H·ªá Th·ªëng Ph√¢n Lo·∫°i S·∫£n Ph·∫©m</h1>
            <p class="text-gray-400 mt-2">Gi√°m s√°t d√¢y chuy·ªÅn th·ªùi gian th·ª±c</p>

            <nav class="bg-gray-800 rounded-lg p-2 mt-6 max-w-sm mx-auto">
                <ul class="flex justify-around">
                    <li><button data-page="page-home"
                            class="nav-btn w-28 py-2 px-4 text-sm font-medium rounded-md transition-colors duration-200">Trang
                            ch·ªß</button></li>
                    <li><button data-page="page-logs"
                            class="nav-btn w-28 py-2 px-4 text-sm font-medium rounded-md transition-colors duration-200">Nh·∫≠t
                            k√Ω</button></li>
                    <li><button data-page="page-test"
                            class="nav-btn w-28 py-2 px-4 text-sm font-medium rounded-md transition-colors duration-200">Ki·ªÉm
                            tra</button></li>
                </ul>
            </nav>
        </header>

        <main class="mt-8">
            <!-- PAGE 1: TRANG CH·ª¶ -->
            <div id="page-home" class="page-content space-y-8">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <div class="bg-gray-800 rounded-2xl shadow-lg p-6">
                        <h2 class="text-2xl font-semibold mb-4 border-b-2 border-gray-700 pb-2">üé• Camera Gi√°m S√°t</h2>
                        <div
                            class="aspect-video bg-black rounded-lg overflow-hidden shadow-inner flex items-center justify-center">
                            <img id="camera-image"
                                src="https://placehold.co/640x480/000000/FFFFFF?text=Ch%E1%BB%9D+t%C3%ADn+hi%E1%BB%87u+t%E1%BB%AB+Pi..."
                                alt="Camera Feed">
                        </div>
                        <p id="qr-result" class="text-center mt-3 text-gray-400 h-6 font-mono"></p>
                    </div>
                    <div class="bg-gray-800 rounded-2xl shadow-lg p-6 flex flex-col">
                        <div
                            class="flex items-center justify-between mb-4 border-b-2 border-gray-700 pb-2 flex-shrink-0">
                            <h2 class="text-2xl font-semibold">Tr·∫°ng Th√°i D√¢y Chuy·ªÅn</h2>
                            <div class="flex items-center gap-4">
                                <span id="connection-status" class="text-sm font-semibold text-yellow-400">‚óè ƒêang k·∫øt
                                    n·ªëi...</span>
                                <button id="reset-button"
                                    class="bg-red-600 hover:bg-red-700 text-white font-bold py-1 px-3 rounded-lg text-sm transition-colors duration-200">Reset</button>
                            </div>
                        </div>
                        <div id="lanes-container" class="space-y-4 flex-grow overflow-y-auto pr-2"></div>
                    </div>
                </div>
                <div class="bg-gray-800 rounded-2xl shadow-lg p-6">
                    <h2 class="text-2xl font-semibold mb-4 border-b-2 border-gray-700 pb-2">‚è±Ô∏è C√†i ƒê·∫∑t T·ªëc ƒê·ªô Chu Tr√¨nh
                    </h2>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 items-end">
                        <div class="space-y-2 md:col-span-2">
                            <label for="cycle-delay" class="text-sm text-gray-400">ƒê·ªô tr·ªÖ chu tr√¨nh ƒë·∫©y (gi√¢y)</label>
                            <input type="number" id="cycle-delay" step="0.1"
                                class="w-full bg-gray-700 rounded-md p-2 text-white border border-gray-600 focus:ring-green-500 focus:border-green-500">
                        </div>
                        <div>
                            <button id="save-timing-btn"
                                class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-md transition-colors">L∆∞u
                                C√†i ƒê·∫∑t</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- PAGE 2: NH·∫¨T K√ù -->
            <div id="page-logs" class="page-content space-y-8 hidden">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <div class="log-card bg-gray-800 rounded-2xl shadow-lg p-6 flex flex-col" style="height: 60vh;">
                        <h2 class="text-2xl font-semibold mb-4 border-b-2 border-gray-700 pb-2 flex-shrink-0">üîç Nh·∫≠t K√Ω
                            Qu√©t M√£ QR</h2>
                        <div id="qr-log-container" class="space-y-3 overflow-y-auto flex-grow pr-2"></div>
                    </div>
                    <div class="log-card bg-gray-800 rounded-2xl shadow-lg p-6 flex flex-col" style="height: 60vh;">
                        <h2 class="text-2xl font-semibold mb-4 border-b-2 border-gray-700 pb-2 flex-shrink-0">üì¶ Nh·∫≠t K√Ω
                            Ph√¢n Lo·∫°i & NG</h2>
                        <div id="sort-log-container" class="space-y-3 overflow-y-auto flex-grow pr-2"></div>
                    </div>
                </div>
            </div>

            <!-- PAGE 3: KI·ªÇM TRA -->
            <div id="page-test" class="page-content space-y-8 hidden">
                <div class="bg-gray-800 rounded-2xl shadow-lg p-6">
                    <h2 class="text-2xl font-semibold mb-4 border-b-2 border-gray-700 pb-2">‚öôÔ∏è Ch·∫ø ƒê·ªô V·∫≠n H√†nh & Test
                    </h2>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <div class="test-card bg-gray-700/50 rounded-lg p-4">
                            <h3 class="font-semibold text-lg mb-4">Ch·ªçn ch·∫ø ƒë·ªô</h3>
                            <div class="space-y-3" id="mode-selector">
                                <label class="flex items-center"><input type="radio" name="op-mode" value="normal"
                                        class="mr-2" checked>Ho·∫°t ƒë·ªông b√¨nh th∆∞·ªùng (Qu√©t QR)</label>
                                <label class="flex items-center"><input type="radio" name="op-mode" value="sensor_test"
                                        class="mr-2">Test C·∫£m bi·∫øn (QR v√¥ hi·ªáu h√≥a)</label>
                            </div>
                            <div class="flex items-center justify-between mt-6">
                                <label for="camera-toggle">G·ª≠i ·∫£nh t·ª´ Camera</label>
                                <label class="cursor-pointer">
                                    <input type="checkbox" id="camera-toggle" class="toggle-input hidden">
                                    <div class="toggle-wrapper">
                                        <div class="toggle-circle"></div>
                                    </div>
                                </label>
                            </div>
                        </div>
                        <div class="test-card bg-gray-700/50 rounded-lg p-4">
                            <h3 class="font-semibold text-lg mb-4">B·∫£ng Test Relay (K√≠ch ho·∫°t trong 1 gi√¢y)</h3>
                            <table class="w-full text-left">
                                <thead class="text-xs text-gray-400 uppercase bg-gray-800">
                                    <tr>
                                        <th class="px-4 py-2">Piston</th>
                                        <th class="px-4 py-2">H√†nh ƒë·ªông</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- C·∫∑p 1 -->
                                    <tr class="border-b border-gray-700">
                                        <td class="px-4 py-3 font-medium">Piston 1 (Lo·∫°i 1)</td>
                                        <td class="px-4 py-3 space-x-2">
                                            <button
                                                class="relay-pulse-btn bg-green-600 hover:bg-green-700 px-3 py-1 rounded-md text-sm"
                                                data-lane="0" data-type="grab">Test Thu</button>
                                            <button
                                                class="relay-pulse-btn bg-red-600 hover:bg-red-700 px-3 py-1 rounded-md text-sm"
                                                data-lane="0" data-type="push">Test ƒê·∫©y</button>
                                        </td>
                                    </tr>
                                    <!-- C·∫∑p 2 -->
                                    <tr class="border-b border-gray-700">
                                        <td class="px-4 py-3 font-medium">Piston 2 (Lo·∫°i 2)</td>
                                        <td class="px-4 py-3 space-x-2">
                                            <button
                                                class="relay-pulse-btn bg-green-600 hover:bg-green-700 px-3 py-1 rounded-md text-sm"
                                                data-lane="1" data-type="grab">Test Thu</button>
                                            <button
                                                class="relay-pulse-btn bg-red-600 hover:bg-red-700 px-3 py-1 rounded-md text-sm"
                                                data-lane="1" data-type="push">Test ƒê·∫©y</button>
                                        </td>
                                    </tr>
                                    <!-- C·∫∑p 3 -->
                                    <tr>
                                        <td class="px-4 py-3 font-medium">Piston 3 (Lo·∫°i 3)</td>
                                        <td class="px-4 py-3 space-x-2">
                                            <button
                                                class="relay-pulse-btn bg-green-600 hover:bg-green-700 px-3 py-1 rounded-md text-sm"
                                                data-lane="2" data-type="grab">Test Thu</button>
                                            <button
                                                class="relay-pulse-btn bg-red-600 hover:bg-red-700 px-3 py-1 rounded-md text-sm"
                                                data-lane="2" data-type="push">Test ƒê·∫©y</button>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        // DOM ELEMENTS
        const connectionStatus = document.getElementById('connection-status');
        const cameraImage = document.getElementById('camera-image');
        const qrResult = document.getElementById('qr-result');
        const resetButton = document.getElementById('reset-button');
        const lanesContainer = document.getElementById('lanes-container');
        const qrLogContainer = document.getElementById('qr-log-container');
        const sortLogContainer = document.getElementById('sort-log-container');
        const cameraToggle = document.getElementById('camera-toggle');
        const modeSelector = document.getElementById('mode-selector');
        const navButtons = document.querySelectorAll('.nav-btn');
        const pages = document.querySelectorAll('.page-content');
        const cycleDelayInput = document.getElementById('cycle-delay');
        const saveTimingBtn = document.getElementById('save-timing-btn');
        const relayPulseButtons = document.querySelectorAll('.relay-pulse-btn');

        const initialLanes = [{ name: "Lo·∫°i 1", icon: "ü•á" }, { name: "Lo·∫°i 2", icon: "ü•à" }, { name: "Lo·∫°i 3", icon: "ü•â" }];

        // --- PAGE SWITCHING ---
        function switchPage(pageId) {
            pages.forEach(page => page.classList.toggle('hidden', page.id !== pageId));
            navButtons.forEach(btn => btn.classList.toggle('active', btn.dataset.page === pageId));
        }
        navButtons.forEach(btn => btn.addEventListener('click', () => switchPage(btn.dataset.page)));

        // --- UI UPDATE FUNCTIONS ---
        function createLaneHTML(lane, index) {
            return `<div id="lane-card-${index}" class="status-card bg-gray-700 rounded-lg p-4 border-l-4 border-gray-500">
                        <div class="flex items-center justify-between">
                            <h3 class="text-lg font-bold">${lane.icon} ${lane.name}</h3>
                            <p id="lane-count-${index}" class="text-xl font-bold text-gray-300">0</p>
                        </div>
                        <div class="flex items-center justify-between mt-1">
                            <p id="lane-status-${index}" class="text-gray-400 text-sm">ƒêang kh·ªüi t·∫°o...</p>
                            <div id="lane-dot-${index}" class="status-dot w-3 h-3 rounded-full bg-gray-500"></div>
                        </div>
                        <div class="grid grid-cols-3 gap-x-2 mt-3 pt-2 border-t border-gray-600 text-xs text-center">
                            <div><p class="font-semibold text-gray-400">C·∫£m Bi·∫øn</p><p id="lane-sensor-${index}" class="font-mono mt-1 text-gray-500">-</p></div>
                            <div><p class="font-semibold text-gray-400">Piston Thu</p><p id="lane-relay-grab-${index}" class="font-mono mt-1 text-gray-500">-</p></div>
                            <div><p class="font-semibold text-gray-400">Piston ƒê·∫©y</p><p id="lane-relay-push-${index}" class="font-mono mt-1 text-gray-500">-</p></div>
                        </div>
                    </div>`;
        }

        function updateLaneUI(index, lane) {
            document.getElementById(`lane-count-${index}`).textContent = lane.count;
            document.getElementById(`lane-status-${index}`).textContent = lane.status;
            const card = document.getElementById(`lane-card-${index}`);
            const dot = document.getElementById(`lane-dot-${index}`);
            dot.className = 'status-dot w-3 h-3 rounded-full ';
            switch (lane.status) {
                case "S·∫µn s√†ng": card.style.borderColor = '#22C55E'; dot.classList.add('bg-green-500'); break;
                case "ƒêang ch·ªù v·∫≠t...": card.style.borderColor = '#EAB308'; dot.classList.add('bg-yellow-500'); break;
                case "ƒêang ph√¢n lo·∫°i...": card.style.borderColor = '#3B82F6'; dot.classList.add('bg-blue-500'); break;
                default: card.style.borderColor = '#6B7280'; dot.classList.add('bg-gray-500'); break;
            }
            const sensorEl = document.getElementById(`lane-sensor-${index}`);
            sensorEl.textContent = lane.sensor === 0 ? "C√ì V·∫¨T" : "Tr·ªëng";
            sensorEl.className = 'font-mono mt-1 ' + (sensorEl.textContent === "C√ì V·∫¨T" ? "font-bold text-yellow-300" : "text-gray-500");

            const grabEl = document.getElementById(`lane-relay-grab-${index}`);
            grabEl.textContent = lane.relay_grab === 1 ? "B·∫¨T" : "T·∫ÆT";
            grabEl.className = 'font-mono mt-1 ' + (grabEl.textContent === "B·∫¨T" ? "font-bold text-green-400" : "text-gray-500");

            const pushEl = document.getElementById(`lane-relay-push-${index}`);
            pushEl.textContent = lane.relay_push === 1 ? "B·∫¨T" : "T·∫ÆT";
            pushEl.className = 'font-mono mt-1 ' + (pushEl.textContent === "B·∫¨T" ? "font-bold text-red-400" : "text-gray-500");
        }

        function addLog(container, message) {
            const logItem = document.createElement('div');
            logItem.className = 'log-item text-sm p-2 rounded-md bg-gray-700/50';
            logItem.innerHTML = message;
            container.prepend(logItem);
            if (container.children.length > 50) container.removeChild(container.lastChild);
        }

        // --- WEBSOCKET CONNECTION ---
        function connectWebSocket() {
            const ws_protocol = window.location.protocol === 'http:' ? 'ws://' : 'wss://';
            const socket = new WebSocket(`${ws_protocol}${window.location.host}/ws`);

            socket.onmessage = (event) => {
                const msg = JSON.parse(event.data);
                if (msg.type === 'state_update') {
                    const systemStatus = msg.state.status;
                    connectionStatus.textContent = systemStatus === "Online" ? "‚óè H·ªá th·ªëng Online" : "‚óè H·ªá th·ªëng Offline";
                    connectionStatus.className = "text-sm font-semibold " + (systemStatus === "Online" ? "text-green-400" : "text-red-400");
                    msg.state.lanes.forEach((lane, index) => updateLaneUI(index, lane));

                    if (msg.state.pi_config) {
                        const config = msg.state.pi_config;
                        cameraToggle.checked = config.camera_enabled;
                        document.querySelector(`input[name="op-mode"][value="${config.operating_mode}"]`).checked = true;
                    }
                    if (msg.state.timing_config) {
                        cycleDelayInput.value = msg.state.timing_config.cycle_delay;
                    }

                } else if (msg.type === 'image_update') {
                    cameraImage.src = `data:image/jpeg;base64,${msg.image}`;
                } else if (msg.type === 'log') {
                    const { log_type, timestamp, data, name, count } = msg;
                    let logHtml = `<span class="font-mono text-gray-400">${timestamp}</span> | `;
                    if (log_type === 'qr') { logHtml += `Qu√©t m√£: <strong class="text-blue-300">${data}</strong>. Ch·ªù ph√¢n lo·∫°i.`; addLog(qrLogContainer, logHtml); qrResult.innerHTML = `Ph√°t hi·ªán: <strong class="text-blue-300">${data}</strong>`; }
                    else if (log_type === 'unknown_qr') { logHtml += `<strong class="text-yellow-400">M√£ kh√¥ng h·ª£p l·ªá:</strong> <strong class="text-yellow-500">${data}</strong>.`; addLog(qrLogContainer, logHtml); qrResult.innerHTML = `M√£ kh√¥ng h·ª£p l·ªá: <strong class="text-yellow-500">${data}</strong>`; }
                    else if (log_type === 'ng_product') { logHtml += `S·∫£n ph·∫©m <strong class="text-gray-400">NG</strong> ƒëi qua.`; addLog(sortLogContainer, logHtml); qrResult.innerHTML = `Ph√°t hi·ªán: <strong class="text-gray-400">${data}</strong>`; }
                    else if (log_type === 'sort') { logHtml += `S·∫£n ph·∫©m <strong>${name}</strong> ƒë√£ ph√¢n lo·∫°i. (T·ªïng: ${count})`; addLog(sortLogContainer, logHtml); }
                }
            };
            socket.onopen = () => { connectionStatus.textContent = "‚óè ƒê√£ k·∫øt n·ªëi WebSocket"; connectionStatus.className = "text-sm text-green-400 font-semibold"; };
            socket.onclose = () => { connectionStatus.textContent = "‚óè M·∫•t k·∫øt n·ªëi. ƒêang th·ª≠ l·∫°i..."; connectionStatus.className = "text-sm text-red-400 font-semibold"; setTimeout(connectWebSocket, 3000); };
            socket.onerror = () => { connectionStatus.textContent = "‚óè L·ªói k·∫øt n·ªëi WebSocket."; connectionStatus.className = "text-sm text-red-400 font-semibold"; };
        }

        // --- COMMAND SENDER ---
        function sendCommand(command) {
            fetch('/test_command', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(command)
            }).catch(error => console.error('Error sending command:', error));
        }

        // --- EVENT LISTENERS ---
        resetButton.addEventListener('click', () => { if (confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën reset to√†n b·ªô b·ªô ƒë·∫øm kh√¥ng?')) { fetch('/reset_counts', { method: 'POST' }); } });
        cameraToggle.addEventListener('change', (e) => { sendCommand({ type: 'toggle_camera', enabled: e.target.checked }); });
        modeSelector.addEventListener('change', (e) => { if (e.target.name === 'op-mode') { sendCommand({ type: 'set_mode', mode: e.target.value }); } });

        saveTimingBtn.addEventListener('click', () => {
            sendCommand({
                type: 'update_timing_config',
                delay: parseFloat(cycleDelayInput.value)
            });
            alert('ƒê√£ g·ª≠i c√†i ƒë·∫∑t t·ªëc ƒë·ªô!');
        });

        relayPulseButtons.forEach(button => {
            button.addEventListener('click', (e) => {
                sendCommand({
                    type: 'pulse_relay',
                    lane: parseInt(e.target.dataset.lane),
                    relay_type: e.target.dataset.type
                });
            });
        });

        // --- INITIAL LOAD ---
        document.addEventListener('DOMContentLoaded', () => {
            lanesContainer.innerHTML = initialLanes.map(createLaneHTML).join('');
            switchPage('page-home');
            connectWebSocket();
        });
    </script>
</body>

</html>